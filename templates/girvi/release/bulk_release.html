{% extends "tenant.html" %}
{% load static %}
{% load crispy_forms_tags%}
{%load crispy_forms_filters%}
{% block content %}

<div class="container">
  <div class="card">
    
    <div class="card-body">
      <div class="alert alert-info" role="alert">
        <h4 class="alert-heading">Bulk Release</h4>
        <p>Release multiple loans at once</p>
      </div>
      {{form.media}}
      <form id="bulk-release-form" hx-post="{% url 'girvi:bulk_release' %}" hx-target="#content" hx-swap="innerHTML"
        _="on htmx:afterRequest reset() me">
        {% csrf_token %}
        {{form|crispy}}
        <button class="btn btn-info" type="submit">Generate Release Forms</button>
      </form>
    </div>
  </div>
  <div class="" id="formset-container">
    {% if formset %}
    <div class="card">
      <div class="card-header">Summary</div>
      <div class="card-body">
        <p class="card-text">
          Total Loans: {{ summary.total_loans }} Principal: {{ summary.total_principal }} Interest: {{summary.total_interest }} Total: {{ summary.total_amount }}
        </p>
      </div>
    </div>
    
    <div class="card">
      <div class="card-header">Release Forms</div>
      <div class="card-body" style="height: 400px; overflow-y: auto;">
        <form method="post">
          {% csrf_token %}
          {{ formset.management_form }}
          <div class="table-responsive">
            <table class="table table-sm">

              <tbody>
                {% for form in formset %}
                <tr>
                  <td>{{ form.loan|as_crispy_field }}</td>
                  <td>{{ form.release_date|as_crispy_field }}</td>
                  <td>{{ form.released_by|as_crispy_field }}</td>
                  <td>{{ form.release_amount|as_crispy_field }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <button class="btn btn-success" type="submit" hx-post="{% url 'girvi:submit_release_formset' %}"
            hx-target="#formset-container" hx-swap="innerHTML">Submit All Forms</button>
        </form>
      </div>
    </div>
    {%endif%}
  </div>
</div>
{% endblock %}